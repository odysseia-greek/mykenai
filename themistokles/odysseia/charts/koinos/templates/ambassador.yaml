{{- define "koinos.ambassador" -}}
{{- println -}}
- name: "{{ .Values.global.commonConfig.images.sidecar.repo }}"
  {{- if .Values.global.commonConfig.config.externalRepo | quote }}
  image: {{ .Values.global.commonConfig.images.imageRepo}}{{ .Values.global.commonConfig.images.sidecar.repo }}:{{ .Values.global.commonConfig.images.sidecar.tag }}
  {{ else }}
  image: {{ .Values.global.commonConfig.images.sidecar.repo }}:{{ .Values.global.commonConfig.images.sidecar.tag }}
  {{- end}}
  env:
    - name: VAULT_SERVICE
      value: {{ .Values.global.commonConfig.envVariables.vaultService }}
    - name: VAULT_TLS
      value:  {{ .Values.global.commonConfig.tlsConfig.vault.enabled | quote }}
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
  envFrom:
    - configMapRef:
        name: {{ .Values.name }}
  ports:
    - containerPort: {{ .Values.global.commonConfig.envVariables.sidecar.port }}
  volumeMounts:
    - name: {{ .Values.global.commonConfig.tlsConfig.vault.name }}
      mountPath: {{ .Values.global.commonConfig.tlsConfig.vault.path }}
      readOnly: true
      {{- range .Values.global.commonConfig.tlsConfig.mounts  }}
    - name: {{ .name }}
      mountPath: {{ .path }}
      readOnly: true
      {{- end }}
  imagePullPolicy: {{ .Values.global.commonConfig.config.pullPolicy }}
  resources:
    requests:
      memory: {{ .Values.global.commonConfig.services.sidecar.requests.memory }}
      cpu: {{ .Values.global.commonConfig.services.sidecar.requests.cpu }}
    limits:
      memory: {{.Values.global.commonConfig.services.sidecar.limits.memory}}
      cpu: {{.Values.global.commonConfig.services.sidecar.limits.cpu}}
{{- end -}}
