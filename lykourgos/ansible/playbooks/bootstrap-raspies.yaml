---
- name: Bootstrap Raspberry Pis for K3s/K0s
  hosts: poleis-prd:poleis-acc
  become: yes
  serial: 1
  vars:
    use_cilium: true           # flip to false if you donâ€™t want cgroup2 mount
    add_util_linux: true       # keep for k3s legacy bits if you like
  tasks:
    - name: Determine cmdline path (newer vs older Raspberry Pi OS)
      set_fact:
        cmdline_path: "{{ item }}"
      with_first_found:
        - /boot/firmware/cmdline.txt
        - /boot/cmdline.txt

    - name: Read current cmdline.txt
      slurp:
        src: "{{ cmdline_path }}"
      register: cmdline_content

    - name: Check if cgroups are already enabled
      set_fact:
        cgroups_enabled: >-
          {{ 'cgroup_enable=cpuset' in (cmdline_content.content | b64decode) and
             'cgroup_enable=memory' in (cmdline_content.content | b64decode) and
             'cgroup_memory=1'      in (cmdline_content.content | b64decode) }}

    - name: Enable cgroups in cmdline.txt (idempotent)
      lineinfile:
        path: "{{ cmdline_path }}"
        regexp: '^(.*rootwait.*)$'
        line: '\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1'
        backrefs: yes
      when: not cgroups_enabled
      register: cgroups_updated

    - name: Ensure /etc/hosts contains all cluster hosts (name -> ansible_host)
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item].ansible_host }} {{ item }}"
        state: present
      loop: "{{ groups['poleis-prd'] | default([]) + groups['poleis-acc'] | default([]) }}"
      when: hostvars[item].ansible_host is defined

    - name: Install Longhorn prerequisites
      apt:
        name:
          - open-iscsi
          - nfs-common
          - util-linux
        state: present
        update_cache: yes

    - name: Ensure iscsid enabled and started
      service:
        name: iscsid
        state: started
        enabled: yes

    - name: Load iscsi_tcp module now (idempotent)
      modprobe:
        name: iscsi_tcp
        state: present

    - name: Persist iscsi_tcp module across reboots
      copy:
        dest: /etc/modules-load.d/iscsi.conf
        content: "iscsi_tcp\n"
        owner: root
        group: root
        mode: "0644"

    - name: Ensure BPF filesystem is mounted
      mount:
        path: /sys/fs/bpf
        src: bpffs
        fstype: bpf
        state: mounted

    - name: Ensure cgroup2 mountpoint exists (for Cilium)
      file:
        path: /run/cilium/cgroupv2
        state: directory
        mode: "0755"
      when: use_cilium

    - name: Ensure cgroups v2 is mounted for Cilium
      mount:
        path: /run/cilium/cgroupv2
        src: none
        fstype: cgroup2
        opts: "defaults"
        state: mounted
      when: use_cilium

    - name: Reboot if cgroups were updated
      reboot:
        reboot_timeout: 300
        post_reboot_delay: 10
        msg: "Rebooting to apply cgroup settings"
      when: cgroups_updated is defined and cgroups_updated.changed