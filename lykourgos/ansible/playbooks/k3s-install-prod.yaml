---
# Installs single control-plane K3s on servers-prd[0] and joins all workers-prd.
# CNI: none (youâ€™ll install Cilium/other yourself) + disable built-in NP.

- name: Install K3s on production control-plane
  hosts: servers-prd
  become: yes
  vars:
    k3s_flags: >
      server --cluster-init
      --flannel-backend=none
      --disable-network-policy
      --node-name {{ inventory_hostname }}
      {% if hostvars[inventory_hostname].k3s_tls_sans is defined %}
      {{ hostvars[inventory_hostname].k3s_tls_sans | map('regex_replace', '^(.*)$', '--tls-san \\1') | join(' ') }}
      {% endif %}
  tasks:
    - name: Restrict to the first server only
      meta: end_host
      when: inventory_hostname != groups['servers-prd'][0]

    - name: Ensure base packages
      apt:
        name: [ curl, iptables ]
        state: present
        update_cache: yes

    - name: Download K3s install script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: "0755"

    - name: Install K3s control-plane (idempotent)
      shell: INSTALL_K3S_EXEC="{{ k3s_flags }}" /tmp/k3s-install.sh
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for API to be ready
      wait_for:
        host: 127.0.0.1
        port: 6443
        timeout: 300

    - name: Ensure ~/.kube for {{ ansible_user }}
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Copy kubeconfig for the local user
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    - name: Fetch kubeconfig locally
      fetch:
        src: "/home/{{ ansible_user }}/.kube/config"
        dest: "./k3s-kubeconfig-{{ inventory_hostname }}"
        flat: yes

    - name: Read K3s node token
      slurp:
        src: /var/lib/rancher/k3s/server/node-token
      register: k3s_token_raw

    - name: Set cluster token fact (on controller)
      set_fact:
        k3s_cluster_token: "{{ k3s_token_raw.content | b64decode | trim }}"

- name: Join production workers to K3s
  hosts: workers-prd
  become: yes
  vars:
    controller: "{{ groups['servers-prd'][0] }}"
    controller_host: "{{ hostvars[controller].ansible_host | default(controller) }}"
  tasks:
    - name: Ensure base packages
      apt:
        name: [ curl, iptables ]
        state: present
        update_cache: yes

    - name: Ensure controller resolves (optional)
      lineinfile:
        path: /etc/hosts
        line: "{{ controller_host }} {{ controller }}"
        state: present

    - name: Download K3s install script
      get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s-install.sh
        mode: "0755"

    - name: Install K3s agent (idempotent)
      shell: >
        ( test -f /etc/systemd/system/k3s-agent.service || true ) ||
        K3S_URL="https://{{ controller_host }}:6443"
        K3S_TOKEN="{{ hostvars[controller].k3s_cluster_token }}"
        /tmp/k3s-install.sh agent --node-name {{ inventory_hostname }}
      args:
        executable: /bin/bash

    - name: Ensure k3s-agent is enabled and running
      systemd:
        name: k3s-agent
        state: started
        enabled: yes
        daemon_reload: yes