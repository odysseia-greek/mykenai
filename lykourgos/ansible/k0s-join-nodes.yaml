---
- hosts: poleis-acc-controller
  become: yes
  tasks:
    - name: Create worker join token (valid 1h)
      shell: "/usr/local/bin/k0s token create --role=worker --expiry 1h"
      register: k0s_worker_token
      changed_when: false

    - name: Share token fact
      set_fact:
        worker_join_token: "{{ k0s_worker_token.stdout }}"

- hosts: poleis-acc-workers
  become: yes
  vars:
    controller_host: "{{ groups['poleis-acc-controller'][0] }}"
  tasks:
    - name: Check if running on Raspberry Pi
      stat:
        path: /boot/firmware/cmdline.txt
      register: rpi_cmdline_new

    - name: Check if running on older Raspberry Pi OS
      stat:
        path: /boot/cmdline.txt
      register: rpi_cmdline_old

    - name: Set cmdline path for newer Raspberry Pi OS
      set_fact:
        cmdline_path: /boot/firmware/cmdline.txt
      when: rpi_cmdline_new.stat.exists

    - name: Set cmdline path for older Raspberry Pi OS
      set_fact:
        cmdline_path: /boot/cmdline.txt
      when: rpi_cmdline_old.stat.exists and not rpi_cmdline_new.stat.exists

    - name: Install Longhorn packages
      apt:
        name:
          - open-iscsi      # REQUIRED
          - nfs-common      # Only needed for RWX/NFS backup target
        state: present
        update_cache: yes

    - name: Ensure iscsid service is enabled and running
      service:
        name: iscsid
        state: started
        enabled: yes

    - name: Load iscsi_tcp kernel module now (idempotent)
      modprobe:
        name: iscsi_tcp
        state: present

    - name: Persist iscsi_tcp module across reboots
      copy:
        dest: /etc/modules-load.d/iscsi.conf
        content: "iscsi_tcp\n"
        owner: root
        group: root
        mode: "0644"

    - name: Read current cmdline.txt
      slurp:
        src: "{{ cmdline_path }}"
      register: cmdline_content
      when: cmdline_path is defined

    - name: Check if cgroups are already enabled
      set_fact:
        cgroups_enabled: "{{ 'cgroup_enable=cpuset' in (cmdline_content.content | b64decode) }}"
      when: cmdline_path is defined

    - name: Enable cgroups in cmdline.txt
      lineinfile:
        path: "{{ cmdline_path }}"
        regexp: '^(.*rootwait.*)$'
        line: '\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1'
        backrefs: yes
      when:
        - cmdline_path is defined
        - not cgroups_enabled
      register: cgroups_updated

    - name: Reboot if cgroups were updated
      reboot:
        msg: "Rebooting to enable cgroups"
        reboot_timeout: 300
      when:
        - cgroups_updated is defined
        - cgroups_updated.changed

    - name: Wait for system to come back online
      wait_for_connection:
        delay: 30
        timeout: 300
      when:
        - cgroups_updated is defined
        - cgroups_updated.changed

    - name: Install required packages
      apt:
        name:
          - curl
          - iptables
        state: present
        update_cache: yes

    - name: Install Longhorn prereqs
      apt:
        name:
          - open-iscsi
          - nfs-common
        state: present
        update_cache: yes

    - name: Ensure iscsid running
      service:
        name: iscsid
        state: started
        enabled: yes

    - name: Ensure pella resolves
      lineinfile:
        path: /etc/hosts
        line: "192.168.1.191  pella"
        state: present

    # make sure k0s binary exists
    - name: Download k0s install script
      get_url:
        url: "https://get.k0s.sh"
        dest: "/tmp/k0s-install.sh"
        mode: '0755'

    - name: Install k0s binary
      shell: "/tmp/k0s-install.sh"
      args:
        creates: /usr/local/bin/k0s

    # --- write token to temp file ---
    - name: Write join token to file
      copy:
        content: "{{ hostvars[controller_host].worker_join_token }}"
        dest: /tmp/k0s-worker.token
        owner: root
        group: root
        mode: '0600'

    # --- install and start worker ---
    - name: Install k0s worker (idempotent)
      shell: >
        test -f /etc/systemd/system/k0sworker.service ||
        /usr/local/bin/k0s install worker --token-file /tmp/k0s-worker.token

    - name: Start/enable worker service
      systemd:
        name: k0sworker
        state: started
        enabled: yes
        daemon_reload: yes
