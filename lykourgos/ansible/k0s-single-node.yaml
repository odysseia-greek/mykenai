
---
- name: Install k0s Single Node Cluster
  hosts: poleis-acc
  become: yes
  vars:
    k0s_version: "v1.33.4+k0s.0"

  tasks:
    - name: Check if running on Raspberry Pi
      stat:
        path: /boot/firmware/cmdline.txt
      register: rpi_cmdline_new

    - name: Check if running on older Raspberry Pi OS
      stat:
        path: /boot/cmdline.txt
      register: rpi_cmdline_old

    - name: Set cmdline path for newer Raspberry Pi OS
      set_fact:
        cmdline_path: /boot/firmware/cmdline.txt
      when: rpi_cmdline_new.stat.exists

    - name: Set cmdline path for older Raspberry Pi OS
      set_fact:
        cmdline_path: /boot/cmdline.txt
      when: rpi_cmdline_old.stat.exists and not rpi_cmdline_new.stat.exists

    - name: Read current cmdline.txt
      slurp:
        src: "{{ cmdline_path }}"
      register: cmdline_content
      when: cmdline_path is defined

    - name: Check if cgroups are already enabled
      set_fact:
        cgroups_enabled: "{{ 'cgroup_enable=cpuset' in (cmdline_content.content | b64decode) }}"
      when: cmdline_path is defined

    - name: Enable cgroups in cmdline.txt
      lineinfile:
        path: "{{ cmdline_path }}"
        regexp: '^(.*rootwait.*)$'
        line: '\1 cgroup_enable=cpuset cgroup_enable=memory cgroup_memory=1'
        backrefs: yes
      when:
        - cmdline_path is defined
        - not cgroups_enabled
      register: cgroups_updated

    - name: Reboot if cgroups were updated
      reboot:
        msg: "Rebooting to enable cgroups"
        reboot_timeout: 300
      when:
        - cgroups_updated is defined
        - cgroups_updated.changed

    - name: Wait for system to come back online
      wait_for_connection:
        delay: 30
        timeout: 300
      when:
        - cgroups_updated is defined
        - cgroups_updated.changed

    - name: Install required packages
      apt:
        name:
          - curl
          - iptables
        state: present
        update_cache: yes

    - name: Download k0s install script
      get_url:
        url: "https://get.k0s.sh"
        dest: "/tmp/k0s-install.sh"
        mode: '0755'

    - name: Install k0s binary using install script
      shell: "/tmp/k0s-install.sh"
      environment:
        K0S_VERSION: "{{ k0s_version }}"
      args:
        creates: /usr/local/bin/k0s

    - name: Create k0s configuration directory
      file:
        path: /etc/k0s
        state: directory
        mode: '0755'

    - name: Generate default k0s configuration
      shell: "/usr/local/bin/k0s config create > /etc/k0s/k0s.yaml"
      args:
        creates: /etc/k0s/k0s.yaml

    - name: Install k0s as a single-node cluster (controller + worker)
      shell: "/usr/local/bin/k0s install controller --single"
      args:
        creates: /etc/systemd/system/k0scontroller.service

    - name: Start and enable k0s service
      systemd:
        name: k0scontroller
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Wait for k0s service to be active
      shell: "systemctl is-active k0scontroller"
      register: k0s_service_check
      until: k0s_service_check.stdout == "active"
      retries: 30
      delay: 10
      changed_when: false

    - name: Wait for API server port to be available
      wait_for:
        port: 6443
        host: 127.0.0.1
        delay: 10
        timeout: 300
        state: started

    - name: Create kubeconfig directory for pi user
      file:
        path: /home/pi/.kube
        state: directory
        owner: pi
        group: pi
        mode: '0755'

    - name: Generate kubeconfig for admin
      shell: "/usr/local/bin/k0s kubeconfig admin"
      register: kubeconfig_content
      changed_when: false

    - name: Write kubeconfig to file
      copy:
        content: "{{ kubeconfig_content.stdout }}"
        dest: /home/pi/.kube/config
        owner: pi
        group: pi
        mode: '0600'

    - name: Fetch kubeconfig to local machine
      fetch:
        src: /home/pi/.kube/config
        dest: "./k0s-kubeconfig-{{ inventory_hostname }}"
        flat: yes

    - name: Verify cluster is working
      shell: "/usr/local/bin/k0s kubectl get nodes"
      register: cluster_status
      changed_when: false

    - name: Show cluster status
      debug:
        var: cluster_status.stdout_lines