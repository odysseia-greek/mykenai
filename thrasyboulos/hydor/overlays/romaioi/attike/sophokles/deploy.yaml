apiVersion: v1
kind: ServiceAccount
metadata:
  name: sophokles
  namespace: attike
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: sophokles-kubelet-proxy-reader
rules:
- apiGroups:
  - ""
  resources:
  - nodes/proxy
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: sophokles-kubelet-proxy-reader
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: sophokles-kubelet-proxy-reader
subjects:
- kind: ServiceAccount
  name: sophokles
  namespace: attike
---
apiVersion: v1
data:
  EUPALINOS_CHANNEL: sophokles
  EUPALINOS_TRACING_SERVICE: eupalinos.attike.svc:50060
  EXCLUDE_NAMESPACES: kube-system,kube-public,kube-node-lease
  HOT_POLICY_NAME: hot_30d
  KUBERNETES_API_ENDPOINT: https://kubernetes.default.svc
  MAX_AGE: "5"
  SCRAPE_INTERVAL: 10s
kind: ConfigMap
metadata:
  name: sophokles
  namespace: attike
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: sophokles
  namespace: attike
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: sophokles
  template:
    metadata:
      labels:
        app.kubernetes.io/name: sophokles
        app.kubernetes.io/part-of: attike
    spec:
      containers:
      - env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        envFrom:
        - configMapRef:
            name: sophokles
        image: ghcr.io/odysseia-greek/sophokles:v0.3.2
        imagePullPolicy: IfNotPresent
        name: sophokles
      serviceAccountName: sophokles
      tolerations:
      - operator: Exists
  updateStrategy:
    type: RollingUpdate
---
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    volumes.odysseia.io/combined: "true"
  labels:
    app: anaximenes
  name: anaximenes
  namespace: attike
spec:
  backoffLimit: 3
  template:
    metadata:
      annotations:
        odysseia-greek/access: tracing;metrics;metrics_rollup
        odysseia-greek/role: alias
        perikles/accesses: solon
      labels:
        app: anaximenes
        version: v0.1.1
    spec:
      containers:
      - env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: ELASTIC_ACCESS
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['odysseia-greek/access']
        envFrom:
        - configMapRef:
            name: sophokles
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/anaximenes:v0.1.1
        imagePullPolicy: Always
        name: anaximenes
        resources:
          limits:
            memory: 64Mi
          requests:
            cpu: 200m
            memory: 64Mi
      - env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        envFrom:
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/aristides:v0.0.2
        imagePullPolicy: Always
        name: aristides
        ports:
        - containerPort: 50051
        resources:
          limits:
            memory: 32Mi
          requests:
            memory: 32Mi
        volumeMounts:
        - mountPath: /app/config/vault
          name: vault-server-tls
          readOnly: true
        - mountPath: /app/config/solon
          name: solon-certs
          readOnly: true
      initContainers:
      - env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: ELASTIC_ROLE
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['odysseia-greek/role']
        - name: ELASTIC_ACCESS
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['odysseia-greek/access']
        envFrom:
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/periandros:v0.1.4
        imagePullPolicy: Always
        name: periandros
        volumeMounts:
        - mountPath: /app/config/solon
          name: solon-certs
          readOnly: true
      restartPolicy: Never
      volumes:
      - name: elastic-internal-tls
        secret:
          secretName: aristoteles-es-http-certs-public
      - name: solon-certs
        secret:
          secretName: solon-tls-certs
      - name: vault-server-tls
        secret:
          secretName: vault-server-tls
