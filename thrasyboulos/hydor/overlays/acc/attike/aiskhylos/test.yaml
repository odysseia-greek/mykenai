apiVersion: v1
kind: ServiceAccount
metadata:
  name: aiskhylos-access-sa
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: aiskhylos
rules:
- apiGroups:
  - ""
  resources:
  - nodes
  verbs:
  - get
- apiGroups:
  - metrics.k8s.io
  resources:
  - nodes
  - pods
  verbs:
  - get
  - list
---
kind: ClusterRoleBinding
metadata:
  name: aiskhylos
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: aiskhylos
sapiVersion: rbac.authorization.k8s.io/v1
subjects:
- kind: ServiceAccount
  name: aiskhylos-access-sa
  namespace: attike
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    volumes.odysseia.io/elastic: "true"
    volumes.odysseia.io/init: "true"
  labels:
    app: aiskhylos
  name: aiskhylos
spec:
  replicas: 1
  selector:
    matchLabels:
      app: aiskhylos
  template:
    metadata:
      annotations:
        odysseia-greek/access: metrics
        odysseia-greek/role: creator
      labels:
        app: aiskhylos
        release: aiskhylos
        version: v0.1.0
    spec:
      containers:
      - env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: WAIT_TIME
          value: "300"
        - name: ELASTIC_SEARCH_USER
          valueFrom:
            secretKeyRef:
              key: user
              name: eumetros-elastic
        - name: ELASTIC_SEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: eumetros-elastic
        envFrom:
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/aiskhylos:v0.1.0
        imagePullPolicy: Always
        name: aiskhylos
        resources:
          limits:
            memory: 64Mi
          requests:
            cpu: 200m
            memory: 32Mi
      serviceAccountName: aiskhylos-access-sa
      volumes:
      - name: elastic-internal-tls
        secret:
          secretName: aristoteles-es-http-certs-public
