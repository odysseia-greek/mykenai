apiVersion: v1
kind: ServiceAccount
metadata:
  name: solon-access-sa
  namespace: delphi
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    release: solon
  name: solon
  namespace: delphi
rules:
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - secrets
  verbs:
  - get
  - list
  - update
  - create
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
- apiGroups:
  - apps
  resources:
  - statefulsets
  verbs:
  - get
  - list
- apiGroups:
  - metrics.k8s.io
  resources:
  - pods
  verbs:
  - get
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: solon
rules:
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - '*'
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: solon
  namespace: delphi
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: solon
subjects:
- kind: ServiceAccount
  name: solon-access-sa
  namespace: delphi
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: solon
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: solon
subjects:
- kind: ServiceAccount
  name: solon-access-sa
  namespace: delphi
---
apiVersion: v1
data:
  VAULT_ROLE: solon
kind: ConfigMap
metadata:
  name: solon
  namespace: delphi
---
apiVersion: v1
kind: Service
metadata:
  name: solon
  namespace: delphi
spec:
  ports:
  - name: https
    port: 5443
    targetPort: 5443
  selector:
    app: solon
---
apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    mount.odysseia.io/combined: "true"
    volumes.odysseia.io/combined: "true"
  labels:
    app: solon
    domain: backend
    env: k3d
    variant: k3d
  name: solon
  namespace: delphi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: solon
  template:
    metadata:
      annotations:
        elastic/indices: dictionary;grammar;text;quiz;tracing;metrics;aggregator
        elastic/roles: api;seeder;hybrid;creator;alias
        perikles/hostname: solon
        perikles/validity: "365"
        solon/namespaces: attike;olympia
      labels:
        app: solon
        release: solon
        version: v0.1.4
    spec:
      containers:
      - env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: SOLON_MANAGED_NAMESPACES
          valueFrom:
            fieldRef:
              fieldPath: metadata.annotations['solon/namespaces']
        - name: AUTH_METHOD
          value: kubernetes
        - name: ELASTIC_SEARCH_USER
          valueFrom:
            secretKeyRef:
              key: user
              name: solon-user
        - name: ELASTIC_SEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: solon-user
        envFrom:
        - configMapRef:
            name: solon
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/solon:v0.1.4
        imagePullPolicy: Always
        livenessProbe:
          httpGet:
            path: /solon/v1/health
            port: 5443
            scheme: HTTPS
          initialDelaySeconds: 20
          periodSeconds: 20
        name: solon
        ports:
        - containerPort: 5443
        readinessProbe:
          httpGet:
            path: /solon/v1/health
            port: 5443
            scheme: HTTPS
          initialDelaySeconds: 1
          periodSeconds: 20
        resources:
          limits:
            memory: 128Mi
          requests:
            cpu: 200m
            memory: 64Mi
        volumeMounts:
        - mountPath: /app/config/elastic
          name: elastic-internal-tls
          readOnly: true
        - mountPath: /app/config/solon
          name: solon-certs
          readOnly: true
        - mountPath: /app/config/vault
          name: vault-server-tls
          readOnly: true
      - env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: ELASTIC_SEARCH_USER
          valueFrom:
            secretKeyRef:
              key: user
              name: agreus-elastic
        - name: ELASTIC_SEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: agreus-elastic
        envFrom:
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/aristophanes:v0.6.3
        imagePullPolicy: Always
        name: aristophanes
        ports:
        - containerPort: 50052
        resources:
          limits:
            memory: 64Mi
          requests:
            cpu: 50m
            memory: 32Mi
        volumeMounts:
        - mountPath: /app/config/elastic
          name: elastic-internal-tls
          readOnly: true
      - env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        envFrom:
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/sophokles:v0.1.0
        imagePullPolicy: Always
        name: sophokles
        ports:
        - containerPort: 50053
        resources:
          limits:
            memory: 64Mi
          requests:
            cpu: 50m
            memory: 32Mi
        volumeMounts:
        - mountPath: /app/config/elastic
          name: elastic-internal-tls
          readOnly: true
      initContainers:
      - env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: AUTH_METHOD
          value: token
        envFrom:
        - configMapRef:
            name: solon
        - configMapRef:
            name: odysseia-common-env
        image: ghcr.io/odysseia-greek/peisistratos:v0.1.3
        imagePullPolicy: Always
        name: peisistratos
        volumeMounts:
        - mountPath: /app/config/vault
          name: vault-server-tls
          readOnly: true
      serviceAccountName: solon-access-sa
      volumes:
      - name: elastic-internal-tls
        secret:
          secretName: aristoteles-es-http-certs-public
      - name: solon-certs
        secret:
          secretName: solon-tls-certs
      - name: vault-server-tls
        secret:
          secretName: vault-server-tls
---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-vault-access-solon
  namespace: delphi
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: vault
  ingress:
  - fromEndpoints:
    - matchLabels:
        app: solon
    toPorts:
    - ports:
      - port: "8200"
        protocol: TCP
