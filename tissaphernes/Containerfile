# Base build
FROM golang:1.25-alpine as base

ARG project_name
ARG TARGETOS
ARG TARGETARCH

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
RUN go install gotest.tools/gotestsum@latest
COPY . .

FROM base as builder
ENV CGO_ENABLED=0

ARG project_name
ARG TARGETOS
ARG TARGETARCH

RUN GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH:-amd64} \
    go test -c -o /out/${project_name} ./tests/e2e

FROM alpine:3.20.0 as prod
WORKDIR /app

ARG project_name

RUN apk add --no-cache ca-certificates tzdata

# compiled test binary
COPY --from=builder /out/${project_name} /app/${project_name}

# gotestsum
COPY --from=base /go/bin/gotestsum /usr/local/bin/gotestsum

# âœ… copy Go toolchain so `go tool test2json` exists
COPY --from=base /usr/local/go /usr/local/go
ENV GOROOT=/usr/local/go
ENV PATH=/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

ENTRYPOINT [ "sh", "-c", "/app/${project_name}" ]